<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chroma 维护工具 UI</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 24px; }
    h1 { margin: 0 0 16px; font-size: 20px; }
    fieldset { border: 1px solid #ddd; padding: 12px; margin-bottom: 16px; }
    legend { color: #333; padding: 0 8px; }
    label { display: inline-block; min-width: 160px; margin-right: 8px; }
    input[type="text"] { width: 420px; }
    button { margin-right: 8px; padding: 6px 12px; }
    .row { margin: 6px 0; }
    #out { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 12px; min-height: 240px; }
    .small { font-size: 12px; color: #666; }
    #tree { white-space: pre-wrap; background: #fafafa; border: 1px solid #eee; padding: 12px; min-height: 240px; }
    details { margin: 4px 0; }
    summary { cursor: pointer; }
    </style>
  </div>
  <div class="row">
    <button onclick="buildTreeView()">构建树 (/sources + /entities)</button>
  </div>
  <div id="tree"></div>
</fieldset>


  <script>
    function getBase() { return document.getElementById('base').value.trim(); }
    function getVsDir() { return document.getElementById('vsdir').value.trim(); }
    function getColl() { return document.getElementById('coll').value.trim(); }
    function getRaw() { return document.getElementById('raw').checked; }
    function getSrc() { return document.getElementById('src').value.trim(); }
    function getKb() { return document.getElementById('kb').value.trim(); }
    function getEmb() { return document.getElementById('emb').value.trim(); }
    function show(data) { document.getElementById('out').textContent = JSON.stringify(data, null, 2); }
    function url(path, params) { const q = new URLSearchParams(params); return `${getBase()}${path}?${q.toString()}`; }

    async function getJson(u) {
      try {
        const resp = await fetch(u, { method: 'GET' });
        const data = await resp.json();
        return data;
      } catch (e) {
        return { status: 'error', message: String(e), url: u };
      }
    }

    async function listCollections() {
      const u = url('/collections', { vectorstore_dir: getVsDir() });
      show({ loading: true, url: u });
      const data = await getJson(u);
      show(data);
    }

    async function listSources() {
      const coll = getColl();
      if (!coll) { return show({ status: 'error', message: '缺少集合名' }); }
      const u = url('/sources', { vectorstore_dir: getVsDir(), collection_name: coll });
      show({ loading: true, url: u });
      const data = await getJson(u);
      show(data);
    }

    async function listEntities() {
      const coll = getColl();
      if (!coll) { return show({ status: 'error', message: '缺少集合名' }); }
      const raw = getRaw();
      const u = url('/entities', { vectorstore_dir: getVsDir(), collection_name: coll, raw: raw ? 1 : 0 });
      show({ loading: true, url: u });
      const data = await getJson(u);
      show(data);
    }

    async function deleteBySource() {
      const coll = getColl(); const src = getSrc();
      if (!coll || !src) { return show({ status: 'error', message: '缺少集合名或source' }); }
      const u = url('/delete_by_source', { vectorstore_dir: getVsDir(), collection_name: coll, source_name: src });
      show({ loading: true, url: u });
      const data = await getJson(u);
      show(data);
    }

    async function ingestKB() {
      const coll = getColl();
      if (!coll) { return show({ status: 'error', message: '缺少集合名' }); }
      const u = url('/ingest', { vectorstore_dir: getVsDir(), collection_name: coll, kb_dir: getKb(), embedding_model: getEmb() });
      show({ loading: true, url: u });
      const data = await getJson(u);
      show(data);
    }
    function basename(p) { try { const parts = String(p).split(/[\\\/]/); return parts[parts.length - 1]; } catch (e) { return p; } }
    function textShort(s, n = 160) { if (typeof s !== 'string') return ''; const t = s.trim(); return t.length > n ? (t.slice(0, n) + '…') : t; }

    async function buildTreeView() {
      const base = document.getElementById('base')?.value?.trim() || 'http://localhost:8001';
      const vsdir = document.getElementById('vsdir')?.value?.trim() || './RAG/chroma_db';
      const collLabel = document.getElementById('coll')?.value?.trim() || '集合';
    
      const srcUrl = `${base}/sources?${new URLSearchParams({ vectorstore_dir: vsdir }).toString()}`;
      const entUrl = `${base}/entities?${new URLSearchParams({ vectorstore_dir: vsdir }).toString()}`;
    
      const tree = document.getElementById('tree');
      tree.textContent = `加载中...\n${srcUrl}\n${entUrl}`;
    
      try {
        const [srcResp, entResp] = await Promise.all([
          fetch(srcUrl).then(r => r.json()),
          fetch(entUrl).then(r => r.json()),
        ]);
        if (srcResp.status !== 'ok') throw new Error(srcResp.message || 'sources 接口错误');
        if (entResp.status !== 'ok') throw new Error(entResp.message || 'entities 接口错误');
    
        const collectionName = entResp.collection_name || collLabel;
    
        // 汇总来源
        const sourceSet = new Set();
        Object.values(srcResp.data || {}).forEach((items) => {
          if (Array.isArray(items)) items.forEach(it => sourceSet.add(it.source));
        });
    
        // 展平实体
        const entities = [];
        Object.values(entResp.data || {}).forEach((items) => {
          if (Array.isArray(items)) items.forEach(it => entities.push(it));
        });
    
        // 按来源分组实体
        const grouped = {};
        entities.forEach((it) => {
          const meta = it?.metadata || {};
          const src = (meta.source || meta.path || '(unknown)');
          if (!grouped[src]) grouped[src] = [];
          grouped[src].push(it);
        });
    
        const allSources = Array.from(new Set([...Object.keys(grouped), ...Array.from(sourceSet)])).sort();
    
        // 构建 DOM（details/summary）
        const root = document.createElement('details');
        root.open = true;
        const rootSummary = document.createElement('summary');
        rootSummary.textContent = `${collectionName}（来源 ${allSources.length}）`;
        root.appendChild(rootSummary);
    
        allSources.forEach((src) => {
          const d2 = document.createElement('details');
          const children = grouped[src] || [];
          const d2sum = document.createElement('summary');
          d2sum.textContent = `${basename(src)}（实体 ${children.length}）`;
          d2.appendChild(d2sum);
    
          const ul = document.createElement('ul');
          children.forEach((it) => {
            const li = document.createElement('li');
            const d3 = document.createElement('details');
            const m = it?.metadata || {};
            const sum3 = document.createElement('summary');
            sum3.textContent = `ID=${it.id} chunk=${m.chunk_index ?? '-'} path=${basename(m.path || '')}`;
            d3.appendChild(sum3);
            const body = document.createElement('div');
            const docDiv = document.createElement('div');
            docDiv.textContent = textShort(it.document || '', 240);
            const metaPre = document.createElement('pre');
            metaPre.textContent = JSON.stringify(m, null, 2);
            body.appendChild(docDiv);
            body.appendChild(metaPre);
            d3.appendChild(body);
            li.appendChild(d3);
            ul.appendChild(li);
          });
          d2.appendChild(ul);
          root.appendChild(d2);
        });
    
        tree.innerHTML = '';
        tree.appendChild(root);
      } catch (err) {
        console.error(err);
        tree.textContent = `构建失败：${err?.message || err}`;
      }
    }
  </script>
</body>
</html>